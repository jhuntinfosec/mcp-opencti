# Project Structure

This document describes the organization of the OpenCTI MCP Server repository.

## Directory Layout

```
mcp-opencti/
├── .github/
│   └── workflows/
│       └── test.yml              # GitHub Actions CI/CD workflow
├── .venv/                        # Virtual environment (not in git)
├── htmlcov/                      # Coverage reports (not in git)
├── __pycache__/                  # Python cache (not in git)
│
├── opencti_mcp_server_v7.py      # Main MCP server implementation
├── test_opencti_mcp_server_v7.py # Comprehensive test suite
│
├── requirements.txt              # Production dependencies
├── requirements-test.txt         # Testing dependencies
├── pytest.ini                    # Pytest configuration
│
├── .env.example                  # Environment variable template
├── .gitignore                    # Git ignore rules
│
├── README.md                     # Main documentation
├── CHANGELOG.md                  # Version history
├── LICENSE                       # MIT License
├── CONTRIBUTING.md               # Contribution guidelines
├── TESTING.md                    # Testing guide
├── TEST_SUMMARY.md               # Test coverage summary
├── NEW_FEATURES.md               # Feature documentation
└── PROJECT_STRUCTURE.md          # This file
```

## Core Files

### Source Code

#### `opencti_mcp_server_v7.py` (989 lines)
Main MCP server implementation containing:
- **26+ MCP tools** for threat intelligence queries
- **7 helper functions** for data processing
- **Environment configuration** handling
- **OpenCTI client** initialization

**Key sections**:
- Lines 1-72: Module documentation and imports
- Lines 73-102: MCP server setup and client initialization
- Lines 103-212: Helper functions
- Lines 213-497: Core MCP tools (search, relationships)
- Lines 498-611: Report tools
- Lines 612-981: Advanced query tools (sector, TTP, temporal)

#### `test_opencti_mcp_server_v7.py` (815 lines)
Comprehensive test suite with 85+ test cases:
- **12 test classes** covering all functionality
- **Full mocking** - no live OpenCTI required
- **Edge case coverage**
- **Error path testing**

## Configuration Files

### `requirements.txt`
Production dependencies:
```
mcp[fastmcp]>=0.1.0
pycti>=6.0.0
python-dotenv>=1.0.0
```

### `requirements-test.txt`
Testing dependencies:
```
pytest>=7.4.0
pytest-cov>=4.1.0
pytest-mock>=3.12.0
black>=23.0.0
flake8>=6.0.0
mypy>=1.5.0
```

### `pytest.ini`
Pytest configuration:
- Test discovery patterns
- Coverage settings
- Output formatting

### `.env.example`
Environment variable template:
```
OPENCTI_URL=http://localhost:8080
OPENCTI_TOKEN=your-api-token-here
```

### `.gitignore`
Excludes from version control:
- Python cache files
- Virtual environments
- IDE files
- Test coverage reports
- Environment files (.env)

## Documentation

### `README.md`
Main project documentation:
- Features overview
- Installation instructions
- Configuration guide
- Usage examples
- API reference
- Troubleshooting

### `CHANGELOG.md`
Version history:
- Release notes
- Features added
- Bug fixes
- Breaking changes
- Migration guides

### `CONTRIBUTING.md`
Contributor guide:
- Development setup
- Coding standards
- Testing requirements
- Pull request process
- Commit guidelines

### `TESTING.md`
Detailed testing guide:
- Running tests
- Coverage reporting
- Test organization
- Writing new tests
- CI/CD integration

### `TEST_SUMMARY.md`
Quick test reference:
- Test statistics
- Coverage breakdown
- Quick start commands
- Example tests

### `NEW_FEATURES.md`
Feature documentation:
- Tool descriptions
- Usage examples
- Implementation details
- Use cases

### `LICENSE`
MIT License text

### `PROJECT_STRUCTURE.md`
This file - project organization guide

## CI/CD

### `.github/workflows/test.yml`
GitHub Actions workflow:
- **Matrix testing**: Python 3.8-3.12 on Linux/macOS/Windows
- **Code quality**: Black, flake8, mypy
- **Test execution**: pytest with coverage
- **Coverage upload**: Codecov integration

## Generated Files (Not in Git)

### `.venv/`
Python virtual environment
- Created with `python3 -m venv .venv`
- Contains installed packages

### `htmlcov/`
HTML coverage reports
- Generated by `pytest --cov-report=html`
- View in browser at `htmlcov/index.html`

### `__pycache__/`
Python bytecode cache
- Automatically created by Python
- Improves import performance

### `.coverage`
Coverage data file
- Created by pytest-cov
- Binary format

### `.env`
Environment variables (DO NOT COMMIT)
- Copy from `.env.example`
- Contains secrets

## File Sizes

- **opencti_mcp_server_v7.py**: ~40 KB
- **test_opencti_mcp_server_v7.py**: ~36 KB
- **README.md**: ~15 KB
- **TESTING.md**: ~8 KB
- **NEW_FEATURES.md**: ~12 KB
- **CHANGELOG.md**: ~6 KB
- **CONTRIBUTING.md**: ~8 KB
- **Total source + tests**: ~76 KB
- **Total documentation**: ~49 KB

## Code Statistics

### Main Server (`opencti_mcp_server_v7.py`)
- **Total lines**: 989
- **Functions**: 33
- **MCP tools**: 26
- **Helper functions**: 7
- **Test coverage**: >90%

### Test Suite (`test_opencti_mcp_server_v7.py`)
- **Total lines**: 815
- **Test classes**: 12
- **Test cases**: 85+
- **Fixtures**: 1 (mock_opencti_client)

## Dependencies

### Production Dependencies
1. **mcp[fastmcp]** - MCP server framework
2. **pycti** - OpenCTI Python client
3. **python-dotenv** - Environment variable management

### Development Dependencies
1. **pytest** - Testing framework
2. **pytest-cov** - Coverage reporting
3. **pytest-mock** - Mocking utilities
4. **black** - Code formatter
5. **flake8** - Linter
6. **mypy** - Type checker

## Key Design Patterns

### Single Client Instance
- One OpenCTI client for all requests
- Initialized at module load
- Connection reuse for performance

### Graceful Error Handling
- Returns empty results instead of errors
- No exceptions to end users
- Preserves database integrity

### Flexible Name Matching
- Exact name search first
- Fallback to fuzzy search
- User-friendly experience

### Comprehensive Documentation
- NumPy-style docstrings
- Type hints throughout
- Usage examples

## Development Workflow

### Initial Setup
```bash
git clone <repo>
cd mcp-opencti
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
pip install -r requirements-test.txt
cp .env.example .env
# Edit .env
```

### Development Cycle
```bash
# Make changes
# Format code
black opencti_mcp_server_v7.py

# Run tests
pytest test_opencti_mcp_server_v7.py -v

# Check coverage
pytest --cov=opencti_mcp_server_v7 --cov-report=html

# Commit
git add .
git commit -m "feat: description"
git push
```

### Pre-commit Checklist
- [ ] Tests pass
- [ ] Code formatted with Black
- [ ] No flake8 errors
- [ ] Documentation updated
- [ ] CHANGELOG updated
- [ ] Type hints added

## Maintenance

### Regular Tasks
- Update dependencies: `pip install --upgrade -r requirements.txt`
- Run security audit: `pip-audit`
- Check for deprecations
- Update documentation
- Review and merge PRs

### Release Checklist
- [ ] All tests passing
- [ ] Documentation updated
- [ ] CHANGELOG updated
- [ ] Version bumped
- [ ] Tag created
- [ ] GitHub release created

## Resources

- **OpenCTI Docs**: https://docs.opencti.io/
- **MCP Spec**: https://modelcontextprotocol.io/
- **pycti GitHub**: https://github.com/OpenCTI-Platform/client-python
- **pytest Docs**: https://docs.pytest.org/
